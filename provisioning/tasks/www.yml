---
- name: Register information about the /vagrant directory.
  stat:
    path: /vagrant
  register: vagrant_directory

- name: Detect if group used to sync directories already exist.
  shell: "getent group {{ vagrant_directory.stat.gid }} | cut -d':' -f1"
  register: vagrant_directory_groupname
  when: vagrant_directory.stat.exists

- name: Ensure a group with the same GID as used to sync directories exist.
  group:
    gid: "{{ vagrant_directory.stat.gid }}"
    name: vagrant_group
    state: present
  when: vagrant_directory.stat.exists and vagrant_directory_groupname.stdout == ''

- name: Ensure www-data user is in the same group as the owner of synced directories.
  user:
    name: www-data
    append: yes
    groups: "{{ vagrant_directory_groupname.stdout|default('vagrant_group') }}"
  when: vagrant_directory.stat.exists

- name: Ensure admin group exist.
  group: "name=admin state=present"

- name: Ensure vagrant user is in admin group.
  user: "name={{ vagrant_user }} append=yes groups=admin"

- name: Set nicer permissions on Apache log directory.
  file:
    path: "/var/log/{{ apache_daemon }}"
    state: directory
    mode: 0755
    recurse: true
  when: drupalvm_webserver == 'apache'

- name: Copy Nginx vhosts into place.
  template:
    src: ../templates/nginx-vhost.conf.j2
    dest: "{{ nginx_vhost_path }}/{{ item.server_name.split(' ')[0] }}.conf"
    force: yes
    owner: root
    group: root
    mode: 0644
  with_items: "{{ nginx_hosts }}"
  notify: restart nginx
  when: drupalvm_webserver == 'nginx'
